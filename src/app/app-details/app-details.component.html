<!-- Include Header Component -->
<app-header></app-header>

<!-- Hero Section with App Header -->
<div class="hero-section">
  <div class="container">
    <div class="app-header-card">
      <div class="row align-items-center g-4">
        <div class="col-lg-2 col-md-3 text-center">
          <div class="app-icon-wrapper">
            <img *ngIf="app.iconUrl" 
                 [ngSrc]="app.iconUrl" 
                 [alt]="app.name + ' Icon'" 
                 class="app-icon"
                 width="120" 
                 height="120"
                 [placeholder]="app.iconUrl"
                 priority>
            <div class="icon-glow"></div>
          </div>
        </div>
        <div class="col-lg-7 col-md-6">
          <div class="app-info">
            <h1 class="app-title">{{ app.name }}</h1>
            <p class="app-publisher">
              <i class="fas fa-user-circle me-2"></i>
              <span class="publisher-name">{{ app.publisher }}</span>
            </p>
            <div class="app-stats">
              <div class="stat-item">
                <div class="rating-display">
                  <span class="rating-number">{{ app.rating }}</span>
                  <div class="stars">
                    <i *ngFor="let star of getStarArray(app.rating)" 
                       class="fas fa-star" 
                       [class.filled]="star === 1"></i>
                  </div>
                </div>
                <span class="reviews-count">({{ app.reviewsCount | number }} reviews)</span>
              </div>
              <div class="badges-container">
                <span class="category-badge">
                  <i class="fas fa-briefcase me-1"></i>Productivity
                </span>
                <span class="feature-badge featured">
                  <i class="fas fa-crown me-1"></i>Top Rated
                </span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-3">
          <div class="download-section">
            <button class="download-btn primary" (click)="downloadApp()">
              <i class="fas fa-download me-2"></i>
              <span>Download Now</span>
            </button>
            <div class="price-info">
              <span class="price">Free</span>
              <span class="file-size">{{ app.version }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Screenshots Gallery -->
<div class="screenshots-section">
  <div class="container">
    <h2 class="section-title">
      <i class="fas fa-images me-2"></i>Screenshots
    </h2>
    <div class="screenshots-carousel">
      <owl-carousel-o [options]="customOptions">
        <ng-container *ngFor="let shot of app.screenshots; let i = index">
          <ng-template carouselSlide>
            <div class="screenshot-wrapper" *ngIf="shot">
              <img [ngSrc]="shot" 
                   [alt]="'Screenshot ' + (i + 1)" 
                   class="screenshot"
                   width="300" 
                   height="600"
                   [placeholder]="shot"
                   (click)="openImageModal(shot, i)">
              <div class="screenshot-overlay">
                <i class="fas fa-expand-alt"></i>
              </div>
            </div>
          </ng-template>
        </ng-container>
      </owl-carousel-o>
    </div>
  </div>
</div>

<!-- App Details: Description, What's New, Version, and Reviews -->
<div class="content-section">
  <div class="container">
    <div class="row g-4">
      <!-- Main Content -->
      <div class="col-lg-8">
        <!-- App Description -->
        <div class="detail-card description-card">
          <h2 class="card-title">
            <i class="fas fa-info-circle me-2"></i>About This App
          </h2>
          <div class="description-content">
            <p class="description-text">{{ app.description }}</p>
          </div>
        </div>

        <!-- What's New Section -->
        <div class="detail-card whats-new-card" *ngIf="app.whatsNew">
          <h3 class="card-title">
            <i class="fas fa-sparkles me-2"></i>What's New
          </h3>
          <div class="whats-new-content">
            <p>{{ app.whatsNew }}</p>
            <div class="version-info">
              <span class="version-badge">
                <i class="fas fa-tag me-1"></i>Version {{ app.version }}
              </span>
            </div>
          </div>
        </div>

        <!-- App Information -->
        <div class="detail-card info-card">
          <h3 class="card-title">
            <i class="fas fa-cog me-2"></i>App Information
          </h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Version</span>
              <span class="info-value">{{ app.version }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Developer</span>
              <span class="info-value">{{ app.publisher }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Category</span>
              <span class="info-value">Productivity</span>
            </div>
            <div class="info-item">
              <span class="info-label">Price</span>
              <span class="info-value">Free</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="detail-card actions-card">
          <div class="quick-actions">
            <button class="action-btn primary" (click)="downloadApp()">
              <i class="fas fa-download me-2"></i>Download Now
            </button>
            <button class="action-btn secondary" (click)="shareApp()">
              <i class="fas fa-share-alt me-2"></i>Share App
            </button>
            <button class="action-btn secondary" (click)="addToWishlist()">
              <i class="fas fa-heart me-2"></i>Add to Wishlist
            </button>
          </div>
        </div>

        <!-- Reviews Section -->
        <div class="detail-card reviews-card">
          <h2 class="card-title">
            <i class="fas fa-star me-2"></i>Ratings & Reviews
          </h2>
          
          <!-- Overall Rating Summary -->
          <div class="rating-summary-wrapper">
            <div class="overall-rating-display">
              <div class="rating-circle">
                <span class="rating-number">{{ app.rating }}</span>
                <div class="rating-stars">
                  <i *ngFor="let star of getStarArray(app.rating)" 
                     class="fas fa-star" 
                     [class.filled]="star === 1"></i>
                </div>
              </div>
              <div class="rating-details">
                <div class="total-reviews">{{ getTotalReviews() | number }} reviews</div>
                <!-- Rating Breakdown -->
                <div class="rating-breakdown">
                  <div class="rating-bar" *ngFor="let i of [5,4,3,2,1]">
                    <span class="rating-label">{{ i }}</span>
                    <i class="fas fa-star star-icon"></i>
                    <div class="progress-bar-container">
                      <div class="progress-bar" 
                           [style.width.%]="getRatingPercentage(
                             i === 5 ? ratingBreakdown.fiveStars :
                             i === 4 ? ratingBreakdown.fourStars :
                             i === 3 ? ratingBreakdown.threeStars :
                             i === 2 ? ratingBreakdown.twoStars :
                             ratingBreakdown.oneStar
                           )"></div>
                    </div>
                    <span class="rating-count">{{
                      i === 5 ? ratingBreakdown.fiveStars :
                      i === 4 ? ratingBreakdown.fourStars :
                      i === 3 ? ratingBreakdown.threeStars :
                      i === 2 ? ratingBreakdown.twoStars :
                      ratingBreakdown.oneStar
                    }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Write Review Button -->
          <div class="write-review-section">
            <button class="write-review-btn" 
                    (click)="toggleReviewForm()"
                    [disabled]="submittingReview">
              <i class="fas fa-pen me-2"></i>
              {{ showReviewForm ? 'Cancel Review' : 'Write a Review' }}
            </button>
            
            <!-- Login prompt for non-authenticated users -->
            <div class="login-prompt" *ngIf="!user">
              <p class="login-text">
                <i class="fas fa-info-circle me-2"></i>
                <a href="/login" class="login-link">Login</a> to write reviews and rate apps
              </p>
            </div>
          </div>

          <!-- Review Form -->
          <div class="review-form-wrapper" *ngIf="showReviewForm && user">
            <div class="review-form-card">
              <h3 class="form-title">Write Your Review</h3>
              
              <!-- Rating Input -->
              <div class="rating-input-section">
                <label class="input-label">Your Rating</label>
                <div class="stars-input-container">
                  <div class="stars-input">
                    <i *ngFor="let i of [1,2,3,4,5]" 
                       class="fas fa-star star-input"
                       [class.filled]="i <= getStarDisplayRating()"
                       [class.hover]="i <= hoverRating"
                       (click)="setRating(i)"
                       (mouseenter)="setHoverRating(i)"
                       (mouseleave)="clearHoverRating()"></i>
                  </div>
                  <span class="rating-text" *ngIf="reviewForm.rating > 0">
                    {{ reviewForm.rating === 1 ? 'Poor' : 
                       reviewForm.rating === 2 ? 'Fair' : 
                       reviewForm.rating === 3 ? 'Good' : 
                       reviewForm.rating === 4 ? 'Very Good' : 'Excellent' }}
                  </span>
                </div>
              </div>

              <!-- Form Fields -->
              <div class="form-fields">
                <div class="form-group">
                  <label for="reviewerName" class="input-label">Your Name</label>
                  <input type="text" 
                         class="form-input" 
                         id="reviewerName"
                         [(ngModel)]="reviewForm.userName"
                         placeholder="Enter your name"
                         maxlength="50">
                  <small class="form-help-text">This will be shown publicly with your review</small>
                </div>

                <div class="form-group">
                  <label for="reviewTitle" class="input-label">Review Title (Optional)</label>
                  <input type="text" 
                         class="form-input" 
                         id="reviewTitle"
                         [(ngModel)]="reviewForm.title"
                         placeholder="Summarize your experience"
                         maxlength="100">
                </div>

                <div class="form-group">
                  <label for="reviewComment" class="input-label">Your Review</label>
                  <textarea class="form-textarea" 
                            id="reviewComment"
                            rows="4"
                            [(ngModel)]="reviewForm.comment"
                            placeholder="Tell others about your experience with this app..."
                            maxlength="500"></textarea>
                  <div class="character-count">
                    {{ reviewForm.comment.length }}/500 characters (minimum 10)
                  </div>
                </div>
              </div>

              <!-- Submit Buttons -->
              <div class="form-actions">
                <button type="submit" 
                        class="submit-btn primary"
                        (click)="submitReview()"
                        [disabled]="!isReviewFormValid() || submittingReview">
                  <span *ngIf="submittingReview" class="spinner"></span>
                  <i *ngIf="!submittingReview" class="fas fa-paper-plane me-2"></i>
                  {{ submittingReview ? 'Submitting...' : 'Submit Review' }}
                </button>
                <button type="button" 
                        class="submit-btn secondary"
                        (click)="toggleReviewForm()"
                        [disabled]="submittingReview">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Reviews List -->
          <div class="reviews-list">
            <div class="reviews-loading" *ngIf="reviewsLoading">
              <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading reviews...</span>
              </div>
            </div>

            <div class="no-reviews" *ngIf="!reviewsLoading && reviews.length === 0">
              <div class="empty-state">
                <i class="fas fa-comment-alt"></i>
                <h4>No reviews yet</h4>
                <p>Be the first to review this app!</p>
              </div>
            </div>

            <div class="review-item" *ngFor="let review of reviews">
              <div class="review-header">
                <div class="user-info">
                  <div class="user-avatar">
                    <img *ngIf="review.userAvatar; else defaultAvatar" 
                         [ngSrc]="review.userAvatar" 
                         [alt]="review.userName"
                         width="40" 
                         height="40"
                         [placeholder]="review.userAvatar">
                    <ng-template #defaultAvatar>
                      <div class="avatar-placeholder">
                        {{ review.userName.charAt(0).toUpperCase() }}
                      </div>
                    </ng-template>
                  </div>
                  <div class="user-details">
                    <h5 class="user-name">{{ review.userName }}</h5>
                    <div class="review-meta">
                      <div class="review-rating">
                        <i *ngFor="let star of getStarArray(review.rating)" 
                           class="fas fa-star" 
                           [class.filled]="star === 1"></i>
                      </div>
                      <span class="review-date">{{ getTimeSince(review.timestamp) }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="review-content">
                <h6 class="review-title" *ngIf="review.title">{{ review.title }}</h6>
                <p class="review-text">{{ review.comment }}</p>
                
                <div class="review-footer" *ngIf="review.appVersion || review.deviceInfo || review.helpfulCount > 0">
                  <div class="review-info">
                    <span *ngIf="review.appVersion" class="version-info">
                      <i class="fas fa-tag"></i>Version {{ review.appVersion }}
                    </span>
                    <span *ngIf="review.deviceInfo" class="device-info">
                      <i class="fas fa-mobile-alt"></i>{{ review.deviceInfo }}
                    </span>
                  </div>
                  <div class="review-actions" *ngIf="review.helpfulCount > 0">
                    <button class="helpful-btn">
                      <i class="fas fa-thumbs-up"></i>
                      {{ review.helpfulCount }} helpful
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Show More/Less Button -->
            <div class="show-more-section" *ngIf="!reviewsLoading && reviews.length > 0">
              <button class="show-more-btn" (click)="toggleShowAllReviews()">
                <i class="fas" [class.fa-chevron-down]="!showAllReviews" [class.fa-chevron-up]="showAllReviews"></i>
                {{ showAllReviews ? 'Show Less Reviews' : 'See All Reviews' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Footer -->
<app-footer></app-footer>
